# Node.js
# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

name: general-ci

variables:
  - group: SonarQube

trigger:
- main

pool:
  vmImage: $(poolvmImage)

stages:
  - stage: Install_NodeJS
    displayName: 'Install NodeJS'
    condition: succeeded()
    jobs:
      - job: Install_Node
        displayName: 'Install Node'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '10.x'
  - stage: Checkout_and_Install
    displayName: 'Checkout and Install'
    jobs:
      - job: Checkout
        displayName: 'Checkout'
        steps:
          - checkout: self
            fetchDepth: 0
      - job: SonarQubePrepare
        steps:
          - task: SonarQubePrepare@5
            displayName: '(Auto SAST) SonarQubePrepare'
            inputs:
              SonarQube: '$(gg_sast_sonarqube_endpoint)'
              scannerMode: 'CLI'
              configMode: 'manual'
              cliProjectKey: '$(gg_sast_sonarqube-cliprojectkey)'
              cliProjectName: '$(gg_sast_sonarqube-cliprojectname)'
              cliProjectVersion: '1.0'
              cliSources: '$(gg_sast_sonarqube-clisources)'
          - task: SonarQubeAnalyze@5
          - task: SonarQubePublish@5
  - stage: Install_Dependencies
    displayName: 'Install Node Dependencies'
    jobs:
      - job: Install
        displayName: 'Install'
        steps:
          - task: Npm@1
            inputs:
              command: 'install'